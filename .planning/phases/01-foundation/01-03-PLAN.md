---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/hooks/useUserBalance.ts
  - src/components/nav/TokenBalance.tsx
  - src/components/nav/TopNav.tsx
  - src/components/nav/BottomNav.tsx
  - src/components/welcome/WelcomeToast.tsx
  - src/app/(app)/layout.tsx
autonomous: true
requirements: [TOKN-01, TOKN-02]

must_haves:
  truths:
    - "New user sees 1,000 tokens immediately after first signup, visible in the navigation bar"
    - "Token balance updates in real-time via Supabase Realtime subscription (no page refresh needed)"
    - "Token balance is derived from SUM of token_ledger rows, not a mutable column"
    - "New user sees a brief celebration toast: 'You got 1,000 tokens! Start betting.'"
    - "Returning user skips the welcome toast and goes straight to the feed"
    - "Token balance is formatted with comma separators and a coin/token icon"
  artifacts:
    - path: "src/hooks/useUserBalance.ts"
      provides: "Real-time token balance hook"
      exports: ["useUserBalance"]
      min_lines: 30
    - path: "src/components/nav/TokenBalance.tsx"
      provides: "Token balance display component"
      min_lines: 15
    - path: "src/components/welcome/WelcomeToast.tsx"
      provides: "First-login celebration component"
      min_lines: 15
  key_links:
    - from: "src/hooks/useUserBalance.ts"
      to: "token_ledger table"
      via: "Supabase query SUM(amount) + Realtime subscription"
      pattern: "supabase.*token_ledger"
    - from: "src/components/nav/TokenBalance.tsx"
      to: "src/hooks/useUserBalance.ts"
      via: "useUserBalance hook import"
      pattern: "useUserBalance"
    - from: "src/app/(app)/layout.tsx"
      to: "src/components/nav/TokenBalance.tsx"
      via: "component rendered in top nav"
      pattern: "TokenBalance"
    - from: "src/components/welcome/WelcomeToast.tsx"
      to: "src/hooks/useUserBalance.ts"
      via: "checks if user is new (just received signup_bonus)"
      pattern: "signup_bonus"
---

<objective>
Wire the token balance display into the navigation bar with real-time updates via Supabase Realtime, and add the first-login celebration toast for new users.

Purpose: Users must always see their current token balance so they know what they can bet. The balance must be derived from the append-only ledger (never a mutable column) and update in real-time as bets are placed in future phases.

Output: Live token balance in nav bar, welcome toast for new users, real-time balance subscription.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUserBalance hook with Realtime subscription</name>
  <files>
    src/hooks/useUserBalance.ts
    src/lib/supabase/client.ts
  </files>
  <action>
    **src/hooks/useUserBalance.ts** -- Custom hook for real-time token balance:

    Create a React hook that:
    1. On mount, queries the user_balances view (created in Plan 01) for the current user's balance: `SELECT balance FROM user_balances WHERE user_id = $1`
    2. Subscribes to Supabase Realtime on the `token_ledger` table filtered by the current user's user_id. On any INSERT to token_ledger for this user, re-fetch the balance.
    3. Returns `{ balance: number, isLoading: boolean, error: string | null }`
    4. Cleans up the Realtime subscription on unmount.
    5. Uses the browser Supabase client (from src/lib/supabase/client.ts).

    The balance is ALWAYS derived from the ledger -- this hook must never read from a mutable balance column. The query should use the user_balances view or equivalent SUM query.

    Enable Supabase Realtime for the token_ledger table. If not already enabled via migration, add it:
    ```sql
    ALTER PUBLICATION supabase_realtime ADD TABLE token_ledger;
    ```
    Add this to a new migration file or append to the existing one if needed.

    Format the balance as a number (the component will handle display formatting).

    Log: DEBUG level for subscription events, WARN if balance query fails.
  </action>
  <verify>
    ```bash
    npm run build
    # No TypeScript errors

    # Manual test: Sign up a new user, verify hook returns 1000
    # Insert a test ledger row via Supabase dashboard, verify balance updates without refresh
    ```
  </verify>
  <done>
    useUserBalance hook returns real-time token balance derived from token_ledger. Supabase Realtime subscription updates balance on any ledger change. Balance is never read from a mutable column.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build TokenBalance component and wire welcome toast into app shell</name>
  <files>
    src/components/nav/TokenBalance.tsx
    src/components/nav/TopNav.tsx
    src/components/nav/BottomNav.tsx
    src/components/welcome/WelcomeToast.tsx
    src/app/(app)/layout.tsx
  </files>
  <action>
    **src/components/nav/TokenBalance.tsx** -- Token balance display:
    - Uses useUserBalance hook
    - Displays: small coin/token icon (use a simple SVG circle or emoji placeholder) + formatted number with comma separators (e.g., "1,000")
    - Per CONTEXT.md: no animation on balance change, instant number update
    - Shows a skeleton/loading state while balance loads
    - Fits in the top nav bar

    **src/components/nav/TopNav.tsx** -- Top navigation bar:
    - App name on the left (the name chosen in Plan 02)
    - TokenBalance component on the right
    - Dark background, sharp edges, minimal styling
    - Fixed at top of viewport

    **src/components/nav/BottomNav.tsx** -- Bottom tab navigation:
    - Three tabs: Feed, Leaderboard, Profile
    - Uses icons (simple SVG or lucide-react icons) + text labels
    - Highlights the active tab based on current route
    - Fixed at bottom of viewport on mobile
    - Dark background matching the app aesthetic
    - Large touch targets for mobile

    **src/components/welcome/WelcomeToast.tsx** -- First-login celebration:
    - Detects if the user just signed up (check if token_ledger has only 1 entry with reason='signup_bonus' -- indicating brand new user)
    - Shows a toast notification: "You got 1,000 tokens! Start betting."
    - Shows a quick tooltip near the balance: "Bet tokens on markets. Top earners win prizes."
    - Only shows once per user (track in localStorage to prevent re-showing)
    - Per CONTEXT.md: returning users skip both, straight to the feed

    **src/app/(app)/layout.tsx** -- Update the app shell:
    - Replace placeholder nav with TopNav component
    - Replace placeholder bottom nav with BottomNav component
    - Add WelcomeToast component (renders conditionally)
    - Layout: TopNav (fixed top) -> content (scrollable, padded for top/bottom nav) -> BottomNav (fixed bottom)
    - Ensure content area has proper padding to avoid overlap with fixed nav bars
  </action>
  <verify>
    ```bash
    npm run dev
    # Sign up new user -> see "You got 1,000 tokens!" toast
    # Balance shows "1,000" in top nav with coin icon
    # Bottom tabs show Feed, Leaderboard, Profile
    # Active tab highlights correctly
    # Refresh page -> balance persists, welcome toast does NOT re-show
    # Log in as existing user -> no welcome toast

    npm run build
    # No TypeScript errors
    ```
  </verify>
  <done>
    Token balance displays in top nav with coin icon and comma-formatted number. Bottom tab bar shows Feed/Leaderboard/Profile with active state. New users see welcome toast on first login only. Balance updates in real-time via Supabase Realtime. App shell is complete with dark trading terminal aesthetic.
  </done>
</task>

</tasks>

<verification>
- [ ] New user sees 1,000 tokens in nav immediately after signup
- [ ] Token balance is formatted with comma separators and coin icon
- [ ] Balance derives from token_ledger SUM, not a mutable column
- [ ] Balance updates in real-time when ledger rows are added (test via Supabase dashboard insert)
- [ ] Welcome toast shows once for new users: "You got 1,000 tokens! Start betting."
- [ ] Returning users skip the welcome toast
- [ ] Top nav has app name + token balance
- [ ] Bottom nav has Feed, Leaderboard, Profile tabs with active highlighting
- [ ] App shell is fully dark mode with trading terminal aesthetic
</verification>

<success_criteria>
Token balance is visible in navigation at all times, derives from the append-only ledger, and updates in real-time. New users see a celebration toast. The app shell is complete with dark, minimal styling and mobile-first bottom tab navigation.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
