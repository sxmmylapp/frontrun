---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/verify/page.tsx
  - src/app/(app)/layout.tsx
  - src/app/(app)/feed/page.tsx
  - src/middleware.ts
  - src/lib/auth/actions.ts
  - src/components/ui/input.tsx
  - src/components/ui/button.tsx
autonomous: true
requirements: [AUTH-01, AUTH-02, AUTH-03]

must_haves:
  truths:
    - "User can enter a phone number on a single login screen and receive an SMS OTP code"
    - "User can enter the OTP code and complete signup (new user) or login (returning user) without any difference in flow"
    - "New user lands on the market feed after OTP verification with no separate onboarding screen"
    - "Returning user lands on the market feed after OTP verification without creating a duplicate account"
    - "User's session survives a browser refresh -- they remain logged in without re-entering their phone number"
    - "Unauthenticated users are redirected to the login page when accessing protected routes"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Phone number input screen"
      min_lines: 40
    - path: "src/app/(auth)/verify/page.tsx"
      provides: "OTP verification screen"
      min_lines: 40
    - path: "src/middleware.ts"
      provides: "Auth middleware for session refresh and route protection"
      min_lines: 20
    - path: "src/lib/auth/actions.ts"
      provides: "Server actions for OTP request and verification"
      exports: ["sendOtp", "verifyOtp"]
    - path: "src/app/(app)/layout.tsx"
      provides: "Authenticated app shell layout"
      min_lines: 20
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/lib/auth/actions.ts"
      via: "sendOtp server action call"
      pattern: "sendOtp"
    - from: "src/app/(auth)/verify/page.tsx"
      to: "src/lib/auth/actions.ts"
      via: "verifyOtp server action call"
      pattern: "verifyOtp"
    - from: "src/middleware.ts"
      to: "@supabase/ssr"
      via: "session refresh middleware"
      pattern: "updateSession"
    - from: "src/app/(auth)/verify/page.tsx"
      to: "src/app/(app)/feed/page.tsx"
      via: "redirect after successful verification"
      pattern: "redirect.*feed"
---

<objective>
Implement the SMS OTP authentication flow: phone number entry, OTP verification, session management, and route protection. The auth flow auto-detects new vs returning users -- a single screen for both signup and login.

Purpose: User identity gates every subsequent feature (token grants, betting, market creation). Auth must be frictionless on mobile: enter phone, get code, you're in.

Output: Working SMS OTP auth flow with session persistence and protected route middleware.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/research/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth server actions and middleware</name>
  <files>
    src/lib/auth/actions.ts
    src/middleware.ts
  </files>
  <action>
    **src/lib/auth/actions.ts** -- Server Actions for OTP flow:

    `sendOtp(phone: string)`:
    - Validate phone number format (E.164 format, use Zod schema)
    - Call supabase.auth.signInWithOtp({ phone }) using the server client
    - Return { success: true } or { error: string }
    - Log: INFO level with timestamp, function name, phone (last 4 digits only for privacy)

    `verifyOtp(phone: string, token: string)`:
    - Validate OTP token format (6 digits, use Zod schema)
    - Call supabase.auth.verifyOtp({ phone, token, type: 'sms' }) using the server client
    - On success: the Supabase trigger (from Plan 01) automatically creates the profile and grants tokens
    - Return { success: true } or { error: string }
    - Log: INFO on success, WARN on invalid token, ERROR on unexpected failure

    Both actions must use 'use server' directive. Handle Supabase auth errors gracefully -- map to user-friendly messages (e.g., "Invalid code, please try again" not raw Supabase error).

    **src/middleware.ts** -- Next.js middleware for session and route protection:

    Use @supabase/ssr updateSession pattern for cookie-based session refresh on every request.

    Route protection logic:
    - /login, /verify: accessible to unauthenticated users only. If authenticated, redirect to /feed.
    - /feed, /leaderboard, /profile, /admin, /markets/*: require authentication. If unauthenticated, redirect to /login.
    - /api/*: handled by individual route handlers (no middleware redirect).
    - Static assets, _next: pass through.

    Configure matcher to cover all app routes but exclude static files.
  </action>
  <verify>
    ```bash
    npm run build
    # No TypeScript errors
    # Middleware compiles without issues
    ```
  </verify>
  <done>
    Server actions for sendOtp and verifyOtp are created with proper validation and error handling. Middleware refreshes sessions and protects routes. Unauthenticated users are redirected to /login; authenticated users on auth pages are redirected to /feed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build auth UI pages and app shell</name>
  <files>
    src/app/(auth)/login/page.tsx
    src/app/(auth)/verify/page.tsx
    src/app/(auth)/layout.tsx
    src/app/(app)/layout.tsx
    src/app/(app)/feed/page.tsx
    src/app/globals.css
  </files>
  <action>
    Install shadcn/ui components needed:
    ```bash
    npx shadcn@latest add button input card toast
    ```

    **Dark mode setup:**
    Configure globals.css for dark mode by default (not system-adaptive). The vibe is clean, minimal, dark -- Polymarket/trading terminal aesthetic, not playful. Sharp edges, no rounded corners on major containers. Use a dark background (#0A0A0F or similar deep dark), subtle borders, and clean typography.

    **src/app/(auth)/layout.tsx** -- Auth layout:
    Centered layout for auth pages. Dark background. App name displayed prominently (choose a short, memorable name fitting for a community prediction market -- Claude's discretion per CONTEXT.md). Minimal -- just the auth card centered on screen.

    **src/app/(auth)/login/page.tsx** -- Phone number input:
    Single screen with one phone number input field (per CONTEXT.md: single screen auth, auto-detects new vs returning user).
    - Phone number input with country code prefix (+1 default for US)
    - "Send Code" button
    - On submit: call sendOtp server action
    - On success: redirect to /verify with phone number passed via search params or state
    - On error: show toast with user-friendly error message
    - Loading state on button during submission
    - Mobile-optimized: large touch targets, numeric keyboard hint (inputMode="tel")

    **src/app/(auth)/verify/page.tsx** -- OTP verification:
    Single text field for OTP code (per CONTEXT.md: single text field, NOT individual digit boxes).
    - Display "Enter the code sent to +1***1234" (masked phone)
    - Single text input for 6-digit code (inputMode="numeric")
    - "Verify" button
    - "Resend code" link with 30-second cooldown timer
    - On submit: call verifyOtp server action
    - On success: redirect to /feed
    - On error: show toast with "Invalid code, please try again"
    - Loading state on button during submission

    **src/app/(app)/layout.tsx** -- Authenticated app shell:
    Dark mode app shell with:
    - Top navigation bar: app name on left, token balance display on right (placeholder "0" for now -- Plan 03 wires real balance)
    - Token balance format: small coin/token icon + formatted number (e.g., "1,000") per CONTEXT.md
    - Bottom tab bar for mobile navigation with 3 tabs: Feed, Leaderboard, Profile (per CONTEXT.md: 3-4 tabs max)
    - Bottom bar uses icons + labels, highlights active tab
    - Responsive: on desktop, sidebar nav instead of bottom bar (or simply wider bottom bar)
    - Content area between nav and bottom bar

    **src/app/(app)/feed/page.tsx** -- Placeholder feed page:
    Simple page with "Markets" heading and "No markets yet" empty state. This is the landing page after auth. Will be built out in Phase 3.

    The aesthetic should feel like a trading terminal, not a social media app (per CONTEXT.md).
  </action>
  <verify>
    ```bash
    npm run dev
    # Visit localhost:3000 -- should redirect to /login
    # Login page shows phone input
    # Enter phone number, click Send Code
    # Verify page shows OTP input
    # Enter valid OTP, redirects to /feed
    # Refresh page -- session persists, stays on /feed
    # Visit /login while authenticated -- redirects to /feed

    npm run build
    # No TypeScript errors
    ```
  </verify>
  <done>
    Auth flow works end-to-end: phone entry -> SMS code -> verification -> feed. Session persists across refresh. Dark mode app shell with nav bar (balance placeholder) and bottom tab bar. New users and returning users use the same flow. UX feels like a trading terminal with dark, minimal aesthetic.
  </done>
</task>

</tasks>

<verification>
- [ ] User can enter phone number on /login and receive SMS OTP
- [ ] User can enter OTP on /verify and complete authentication
- [ ] New user signup and returning user login use the same flow
- [ ] Session survives browser refresh
- [ ] Unauthenticated access to /feed redirects to /login
- [ ] Authenticated access to /login redirects to /feed
- [ ] App shell has dark mode styling with trading terminal aesthetic
- [ ] Bottom tab bar shows Feed, Leaderboard, Profile tabs
- [ ] Token balance placeholder visible in top nav
</verification>

<success_criteria>
Users can sign up and log in via SMS OTP through a single frictionless flow. Sessions persist across refreshes. Protected routes are gated by middleware. The app shell establishes the dark, minimal trading terminal aesthetic.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
