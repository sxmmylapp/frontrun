---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00001_initial_schema.sql
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/types/db.ts
  - .env.local
  - package.json
autonomous: true
requirements: [AUTH-04, TOKN-05]
user_setup:
  - service: supabase
    why: "Database and auth backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role key"
  - service: twilio
    why: "SMS OTP delivery for phone auth"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info"
      - name: TWILIO_VERIFY_SERVICE_SID
        source: "Twilio Console -> Verify -> Services"
    dashboard_config:
      - task: "Create Verify Service"
        location: "Twilio Console -> Verify -> Services -> Create new"
      - task: "Configure Supabase phone provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Phone -> Enable Twilio"

must_haves:
  truths:
    - "Next.js 16 project bootstrapped and running locally with Tailwind v4 and shadcn/ui"
    - "Supabase project created with phone auth enabled via Twilio Verify"
    - "Database schema deployed with profiles, token_ledger, and all required constraints"
    - "Phone number has a UNIQUE constraint at the database level preventing multi-accounting"
    - "Token ledger table is append-only with no mutable balance column anywhere"
    - "Three distinct Supabase clients exist: browser (anon), server (cookies), admin (service-role)"
  artifacts:
    - path: "supabase/migrations/00001_initial_schema.sql"
      provides: "Database schema for profiles and token_ledger"
      contains: "CREATE TABLE profiles"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createBrowserClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client with cookie handling"
      exports: ["createServerClient"]
    - path: "src/lib/supabase/admin.ts"
      provides: "Service-role Supabase client"
      exports: ["createAdminClient"]
  key_links:
    - from: "supabase/migrations/00001_initial_schema.sql"
      to: "Supabase hosted database"
      via: "supabase db push or migration apply"
      pattern: "CREATE TABLE"
    - from: "src/lib/supabase/server.ts"
      to: "@supabase/ssr"
      via: "createServerClient import"
      pattern: "createServerClient"
---

<objective>
Bootstrap the Next.js 16 project, create the Supabase project with phone auth configured via Twilio Verify, and deploy the foundational database schema (profiles table with phone uniqueness constraint, append-only token_ledger table).

Purpose: Every subsequent plan depends on the project scaffold, database schema, and Supabase client utilities. This must be correct from day one -- the append-only ledger design and phone uniqueness constraint cannot be retrofitted without destructive migration.

Output: Running Next.js 16 app with Supabase connected, database schema deployed, three Supabase client utilities ready for use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bootstrap Next.js 16 project with core dependencies</name>
  <files>
    package.json
    src/app/layout.tsx
    src/app/page.tsx
    tailwind.config.ts
    .env.local
  </files>
  <action>
    Bootstrap Next.js 16 project using create-next-app with TypeScript, Tailwind, App Router, Turbopack, and src directory:

    ```bash
    npx create-next-app@latest . --typescript --tailwind --app --turbopack --src-dir --yes
    ```

    Install core dependencies:
    ```bash
    npm install @supabase/supabase-js @supabase/ssr zustand zod react-hook-form date-fns decimal.js
    ```

    Initialize shadcn/ui:
    ```bash
    npx shadcn@latest init -d
    ```

    Install dev dependencies:
    ```bash
    npm install -D supabase
    ```

    Create Supabase project using CLI:
    ```bash
    supabase projects create "prediction-market" --db-password "$(openssl rand -base64 32)" --region us-east-1
    ```

    Link the local project to the Supabase project:
    ```bash
    supabase link --project-ref <project-ref-from-create>
    ```

    Configure Twilio Verify as the SMS provider in Supabase Dashboard (use credentials from ~/templates/.env.master if available, otherwise check Supabase CLI options).

    Create .env.local with Supabase URL, anon key, and service role key (retrieve via `supabase status` or dashboard).

    Set NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, and SUPABASE_SERVICE_ROLE_KEY.

    Add app version display: create src/lib/version.ts exporting APP_VERSION from package.json version field. Display in layout footer or nav as "v1.0.0".
  </action>
  <verify>
    ```bash
    npm run dev
    # App starts on localhost:3000 without errors
    npx supabase status
    # Shows linked project with API URL and keys
    ```
  </verify>
  <done>
    Next.js 16 app runs locally with Tailwind v4 and shadcn/ui initialized. Supabase project is created and linked. Environment variables are set in .env.local. Version string visible in app.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy database schema and create Supabase client utilities</name>
  <files>
    supabase/migrations/00001_initial_schema.sql
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/types/db.ts
  </files>
  <action>
    Create the initial database migration (supabase/migrations/00001_initial_schema.sql) with the following tables:

    **profiles table:**
    - id: UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE
    - phone: TEXT UNIQUE NOT NULL (enforces one-account-per-phone at DB level)
    - display_name: TEXT NOT NULL
    - is_admin: BOOLEAN DEFAULT FALSE
    - created_at: TIMESTAMPTZ DEFAULT NOW()
    - updated_at: TIMESTAMPTZ DEFAULT NOW()
    - Add a unique index on phone column

    **token_ledger table (append-only, source of truth for balances):**
    - id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - user_id: UUID NOT NULL REFERENCES profiles(id)
    - amount: NUMERIC NOT NULL (positive = credit, negative = debit)
    - reason: TEXT NOT NULL CHECK (reason IN ('signup_bonus', 'bet_placed', 'resolution_payout', 'market_cancelled_refund', 'adjustment'))
    - reference_id: UUID (nullable, for traceability to bet/market)
    - created_at: TIMESTAMPTZ DEFAULT NOW()
    - Add index on (user_id, created_at)
    - NO mutable balance column anywhere -- balance is always derived via SUM(amount) WHERE user_id = $1

    **Create a balance view:**
    ```sql
    CREATE VIEW user_balances AS
    SELECT user_id, COALESCE(SUM(amount), 0) AS balance
    FROM token_ledger
    GROUP BY user_id;
    ```

    **RLS policies:**
    - profiles: Users can read their own profile. Service role can insert/update.
    - token_ledger: Users can read their own ledger entries. Only service role can insert (no client-side token manipulation).
    - Enable RLS on both tables.

    **Auto-create profile on signup trigger:**
    Create a PostgreSQL function and trigger that fires after INSERT on auth.users. The function should:
    1. Insert a row into profiles with the user's id, phone from auth.users.phone, and a fun random display name
    2. Insert a signup_bonus row into token_ledger (amount: 1000, reason: 'signup_bonus')

    For random display names, create a function that combines an adjective + animal (e.g., "Lucky Llama", "Swift Fox", "Bold Eagle"). Include ~20 adjectives and ~20 animals.

    Deploy the migration:
    ```bash
    supabase db push
    ```

    Generate TypeScript types:
    ```bash
    supabase gen types typescript --linked > src/types/db.ts
    ```

    Create three Supabase client utilities:

    **src/lib/supabase/client.ts** -- Browser client (anon key, RLS enforced):
    Uses @supabase/ssr createBrowserClient. For client components only.

    **src/lib/supabase/server.ts** -- Server client (cookie-based session):
    Uses @supabase/ssr createServerClient with Next.js cookies() API. For Server Components, Server Actions, and Route Handlers.

    **src/lib/supabase/admin.ts** -- Admin client (service-role, bypasses RLS):
    Uses @supabase/supabase-js createClient with SUPABASE_SERVICE_ROLE_KEY. For admin operations only (resolution, payouts). Never expose to client.
  </action>
  <verify>
    ```bash
    supabase db push
    # Migration applies without errors

    supabase gen types typescript --linked > src/types/db.ts
    # Types generated successfully

    # Verify schema in Supabase dashboard or via SQL:
    # SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
    # Should show: profiles, token_ledger

    npm run build
    # No TypeScript errors
    ```
  </verify>
  <done>
    Database schema deployed with profiles (phone UNIQUE constraint) and token_ledger (append-only, no mutable balance column). RLS policies active. Auto-profile-creation trigger fires on signup, grants 1,000 tokens. Three distinct Supabase clients created. TypeScript types generated from schema.
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run dev` starts the Next.js 16 app without errors
- [ ] Supabase project is created, linked, and accessible
- [ ] Database has profiles and token_ledger tables
- [ ] profiles.phone has a UNIQUE constraint
- [ ] token_ledger has no mutable balance column -- only append-only rows
- [ ] RLS policies prevent client-side token manipulation
- [ ] Auth trigger creates profile + grants 1,000 tokens on signup
- [ ] Three Supabase clients exist with correct privilege levels
- [ ] TypeScript types generated from schema
- [ ] Version string displayed in app
</verification>

<success_criteria>
Next.js 16 project is bootstrapped and running. Supabase project is created with phone auth enabled. Database schema is deployed with phone uniqueness constraint and append-only token ledger. Three Supabase client utilities are ready for use by subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
