---
phase: 08-purchase-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/buy/page.tsx
  - src/app/(app)/buy/BuyTokensClient.tsx
  - src/components/payments/TierSelector.tsx
  - src/components/payments/CheckoutForm.tsx
autonomous: true
requirements: [PURC-01, PURC-02, PURC-03, PURC-04]

must_haves:
  truths:
    - "The /buy page displays three token pack cards: $5/500 tokens, $10/1,100 tokens (+10% bonus), $20/2,400 tokens (+20% bonus)"
    - "Selecting a tier and paying via Express Checkout Element calls POST /api/payments/create-intent and then stripe.confirmPayment"
    - "When Express Checkout is not available (no wallet), a Payment Element fallback renders for card entry"
    - "After successful payment, user sees a confirmation state and their token balance updates in the nav via Realtime"
    - "The buy page is protected by auth middleware (inside (app)/ route group)"
  artifacts:
    - path: "src/app/(app)/buy/page.tsx"
      provides: "Server component page shell for buy page"
      exports: ["default"]
    - path: "src/app/(app)/buy/BuyTokensClient.tsx"
      provides: "Client component with Stripe Elements, tier selection, and checkout flow"
      exports: ["BuyTokensClient"]
---

<objective>
Build the /buy page with token pack selection, Express Checkout Element for Apple Pay / Google Pay, Payment Element fallback for card entry, and purchase confirmation. The page uses deferred PaymentIntent creation (created on confirm, not on page load) following the architecture research patterns.

Purpose: Users need a way to purchase token packs with real USD. This is the user-facing completion of the payment flow â€” the backend (Phase 7) handles creation and fulfillment, this phase handles the UI.

Output: A working /buy page that allows users to select a tier, pay via wallet or card, and see their balance update in real-time.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create tier selector, checkout form, and buy page</name>
  <files>
    src/components/payments/TierSelector.tsx
    src/components/payments/CheckoutForm.tsx
    src/app/(app)/buy/BuyTokensClient.tsx
    src/app/(app)/buy/page.tsx
  </files>
  <action>
**1. Create TierSelector component** at `src/components/payments/TierSelector.tsx`:
- Display three tier cards from TIERS constant (imported from `@/lib/stripe/tiers`)
- Each card shows: price, token count, bonus badge for medium/large
- Selected tier has visual highlight (border color change)
- Mobile-first: cards stack vertically

**2. Create CheckoutForm component** at `src/components/payments/CheckoutForm.tsx`:
- 'use client' component that uses `useStripe()` and `useElements()`
- Renders `ExpressCheckoutElement` with `onConfirm` handler
- Uses `onReady` callback to detect if wallet buttons are available
- If no wallet available, renders `PaymentElement` as fallback
- `onConfirm` flow: `elements.submit()` -> `fetch /api/payments/create-intent` -> `stripe.confirmPayment()`
- Shows error messages from Stripe
- Shows loading state during payment processing
- After successful payment (redirect back with ?success=true), shows confirmation state

**3. Create BuyTokensClient** at `src/app/(app)/buy/BuyTokensClient.tsx`:
- 'use client' component that wraps TierSelector + CheckoutForm
- Manages selected tier state
- Wraps checkout in `<Elements>` provider with `mode: 'payment'`, `amount`, `currency: 'usd'`
- Re-creates Elements when tier changes (key prop on Elements)
- Handles ?success=true query param to show success state
- Success state: green checkmark, "Tokens purchased!" message, link back to feed

**4. Create buy page** at `src/app/(app)/buy/page.tsx`:
- Simple server component that renders BuyTokensClient
- Page title "Buy Tokens"
  </action>
  <verify>
- `npm run build` succeeds
- All 4 files exist
- BuyTokensClient uses `stripePromise` from `@/lib/stripe/client`
- CheckoutForm uses `ExpressCheckoutElement` and `PaymentElement` from `@stripe/react-stripe-js`
- TierSelector imports TIERS from `@/lib/stripe/tiers`
  </verify>
  <done>
- /buy page renders with three tier cards
- Express Checkout Element renders for wallet payments
- Payment Element fallback renders when no wallet available
- Deferred PaymentIntent creation on confirm
- Success state after payment
  </done>
</task>

</tasks>
